<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Editor</title>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen" x-data="app()" x-init="init()">
  
  <!-- Toast Notification -->
  <div id="toast" class="fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg z-[100] opacity-0 transition-opacity duration-300"></div>

  <!-- Main Layout Container -->
  <div class="flex h-screen">
    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col overflow-hidden" :class="$store.chat?.isOpen ? 'mr-0' : ''">

  <!-- Header -->
  <header class="bg-gray-800 border-b border-gray-700 px-4 py-2 flex-shrink-0">
    <div class="flex items-center justify-between">
      <h1 class="text-xl font-bold text-blue-400">üìä Game Data Editor</h1>
      <div class="flex items-center gap-4">
        <span x-show="loading" class="text-yellow-400 text-sm">Loading...</span>
        <span x-show="!loading && lastSaved" class="text-gray-500 text-sm" x-text="'Last saved: ' + lastSaved"></span>
        <button @click="reload()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm">
          üîÑ Reload
        </button>
        <!-- Chat Toggle Button -->
        <button @click="$store.chat.isOpen = !$store.chat.isOpen" 
                class="px-3 py-1 rounded text-sm"
                :class="$store.chat?.isOpen ? 'bg-blue-600 hover:bg-blue-500' : 'bg-gray-700 hover:bg-gray-600'">
          üí¨ AI Chat
        </button>
      </div>
    </div>
  </header>

  <!-- Activity Views (Tier 1) with View Editor -->
  <nav class="bg-gray-800 border-b border-gray-700 px-4 py-2" x-data="{ ...GDEditNav.viewEditor(), ...GDEditNav.tabPinning() }" x-init="init(); loadPinnedTabs()">
    <div class="flex items-center gap-2">
      <template x-for="view in views" :key="view.name">
        <div class="tab-container relative" :class="isPinned('view:' + view.name) ? 'tab-pinned' : ''">
          <button 
            @click="setView(view)"
            @contextmenu.prevent="openEditView(view)"
            :style="currentView?.name === view.name && view.color ? `background-color: ${view.color}` : ''"
            :class="currentView?.name === view.name ? (view.color ? 'text-white' : 'bg-blue-600 text-white') : 'bg-gray-700 hover:bg-gray-600'"
            class="px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-1">
            <span x-text="view.icon + ' ' + view.name"></span>
            <span x-show="isPinned('view:' + view.name)" @click.stop="togglePin(view.name, 'view')" class="pinned-indicator cursor-pointer hover:text-red-400" title="Click to unpin">üìå</span>
          </button>
          <button @click="togglePin(view.name, 'view')" 
                  class="tab-pin-btn absolute -top-1 -right-1 w-5 h-5 bg-gray-600 rounded-full text-xs flex items-center justify-center hover:bg-gray-500"
                  :class="isPinned('view:' + view.name) ? 'text-yellow-400' : 'text-gray-400'">
            üìå
          </button>
        </div>
      </template>
      <button @click="openCreateView()" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm" title="Create new view">
        + View
      </button>
    </div>
    
    <!-- View Editor Dialog -->
    <div x-show="showViewEditor" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-gray-800 rounded-lg p-6 w-[500px] max-h-[80vh] overflow-y-auto border border-gray-600" @click.away="closeViewEditor()">
        <h2 class="text-lg font-bold mb-4" x-text="isCreatingNew ? '‚ú® Create New View' : '‚úèÔ∏è Edit View'"></h2>
        
        <div class="space-y-4">
          <!-- View Name -->
          <div>
            <label class="block text-sm text-gray-400 mb-1">Name</label>
            <input type="text" x-model="viewForm.name" placeholder="View name"
                   class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
          </div>
          
          <!-- Icon Selection -->
          <div>
            <label class="block text-sm text-gray-400 mb-1">Icon</label>
            <div class="flex flex-wrap gap-2">
              <template x-for="icon in availableIcons" :key="icon">
                <button @click="viewForm.icon = icon" 
                        :class="viewForm.icon === icon ? 'ring-2 ring-blue-500' : ''"
                        class="w-10 h-10 bg-gray-700 rounded flex items-center justify-center text-xl hover:bg-gray-600"
                        x-text="icon"></button>
              </template>
            </div>
          </div>
          
          <!-- Color -->
          <div>
            <label class="block text-sm text-gray-400 mb-1">Color</label>
            <input type="color" x-model="viewForm.color" class="w-20 h-8 rounded cursor-pointer">
          </div>
          
          <!-- Classes Selection -->
          <div>
            <label class="block text-sm text-gray-400 mb-1">Visible Classes (empty = all)</label>
            <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto bg-gray-700 rounded p-3">
              <template x-for="cls in $store.editor.classes" :key="cls">
                <button @click="toggleClass(cls)" 
                        :class="isClassSelected(cls) ? 'bg-blue-600 text-white' : 'bg-gray-600'"
                        class="px-3 py-1 rounded text-sm" x-text="cls"></button>
              </template>
            </div>
          </div>
          
          <!-- Default Sort -->
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm text-gray-400 mb-1">Default Sort Column</label>
              <select x-model="viewForm.defaultSort.column" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                <option value="_id">_id</option>
                <option value="_class">_class</option>
                <template x-for="col in $store.editor.columns" :key="col.id">
                  <option :value="col.id" x-text="col.id"></option>
                </template>
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Direction</label>
              <select x-model="viewForm.defaultSort.direction" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                <option value="asc">Ascending ‚Üë</option>
                <option value="desc">Descending ‚Üì</option>
              </select>
            </div>
          </div>
          
          <!-- Read-only Option -->
          <label class="flex items-center gap-2">
            <input type="checkbox" x-model="viewForm.readOnly" class="rounded">
            <span class="text-sm">Read-only mode</span>
          </label>
        </div>
        
        <div class="mt-6 flex justify-between">
          <button x-show="!isCreatingNew" @click="deleteView()" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded">
            Delete
          </button>
          <div class="flex gap-3">
            <button @click="closeViewEditor()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded">Cancel</button>
            <button @click="saveView()" :disabled="!viewForm.name" 
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-600 rounded">
              <span x-text="isCreatingNew ? 'Create' : 'Save'"></span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Class Tabs (Tier 2) with Pinning -->
  <nav class="bg-gray-850 border-b border-gray-700 px-4 py-2 flex gap-2 overflow-x-auto" x-data="GDEditNav.tabPinning()" x-init="init()">
    <button 
      @click="selectClass(null)"
      :class="!selectedClass ? 'bg-blue-600 text-white' : 'bg-gray-700 hover:bg-gray-600'"
      class="px-3 py-1.5 rounded text-sm whitespace-nowrap">
      All
    </button>
    <!-- Pinned classes first -->
    <template x-for="cls in getPinnedOfType('class').filter(c => filteredClasses.includes(c))" :key="'pinned-' + cls">
      <div class="tab-container relative tab-pinned group">
        <button 
          @click="selectClass(cls)"
          :class="selectedClass === cls ? 'bg-blue-600 text-white' : 'bg-gray-700 hover:bg-gray-600'"
          class="px-3 py-1.5 rounded text-sm whitespace-nowrap flex items-center gap-1">
          <span @click.stop="togglePin(cls, 'class')" class="pinned-indicator text-xs cursor-pointer hover:text-red-400" title="Click to unpin">üìå</span>
          <span x-text="cls"></span>
        </button>
      </div>
    </template>
    <!-- Non-pinned classes -->
    <template x-for="cls in filteredClasses.filter(c => !getPinnedOfType('class').includes(c))" :key="cls">
      <div class="tab-container relative group">
        <button 
          @click="selectClass(cls)"
          :class="selectedClass === cls ? 'bg-blue-600 text-white' : 'bg-gray-700 hover:bg-gray-600'"
          class="px-3 py-1.5 rounded text-sm whitespace-nowrap"
          x-text="cls">
        </button>
        <button @click.stop="togglePin(cls, 'class')" 
                class="tab-pin-btn absolute -top-1 -right-1 w-4 h-4 bg-gray-600 rounded-full text-xs flex items-center justify-center hover:bg-gray-500 text-gray-400">
          üìå
        </button>
      </div>
    </template>
  </nav>

  <!-- Component Sub-Tabs (Tier 3) -->
  <nav x-data="GDEditNav.componentSubTabs()" x-init="init()" x-show="hasComponents && selectedClass" x-cloak
       class="bg-gray-800/50 border-b border-gray-700 px-4 py-1.5 flex items-center gap-2">
    <span class="text-xs text-gray-500 mr-2">Components:</span>
    <button @click="selectComponent(null)"
            :class="!selectedComponent ? 'active' : ''"
            class="component-tab">
      All
    </button>
    <template x-for="comp in components" :key="comp">
      <button @click="selectComponent(comp)"
              :class="selectedComponent === comp ? 'active' : ''"
              class="component-tab"
              x-text="comp">
      </button>
    </template>
  </nav>

  <!-- Child-Tabs (Tier 4) for nested data -->
  <nav x-data="GDEditNav.childTabs()" x-init="init()" x-show="hasNestedData && selectedClass" x-cloak
       class="bg-gray-800/30 border-b border-gray-700 px-4 py-1.5 flex items-center gap-2">
    <span class="text-xs text-gray-500 mr-2">Nested:</span>
    <template x-for="path in nestedPaths" :key="path.path">
      <button @click="selectPath(path.path)"
              :class="selectedPath === path.path ? 'active' : ''"
              class="child-tab flex items-center gap-1">
        <span x-text="path.path"></span>
        <span class="text-xs opacity-60" x-text="'(' + path.count + ')'"></span>
      </button>
    </template>
  </nav>

  <!-- Toolbar -->
  <div x-data="{ ...toolbar(), ...clipboard(), ...fileDialog(), ...validationManager() }" x-init="init()" class="bg-gray-800 border-b border-gray-700 px-4 py-2">
    <div class="flex flex-wrap items-center gap-3">
      <!-- Add Buttons -->
      <div class="flex items-center gap-1">
        <button 
          @click="$store.editor.showAddModal = true"
          :disabled="!$store.editor.selectedClass"
          class="px-3 py-1.5 bg-green-600 hover:bg-green-500 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-l text-sm">
          + Add
        </button>
        <button 
          @click="$store.editor.showBulkAddModal = true"
          :disabled="!$store.editor.selectedClass"
          class="px-2 py-1.5 bg-green-600 hover:bg-green-500 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-r text-sm border-l border-green-700">
          ‚ñæ
        </button>
        <button 
          @click="deleteSelected()"
          :disabled="$store.editor.selectedRows.length === 0"
          class="px-3 py-1.5 bg-red-600 hover:bg-red-500 disabled:bg-gray-600 disabled:cursor-not-allowed rounded text-sm ml-1">
          üóëÔ∏è
        </button>
      </div>

      <div class="w-px h-6 bg-gray-600"></div>

      <!-- Copy/Paste Buttons -->
      <div class="flex items-center gap-1">
        <div class="relative" x-data="{ open: false }">
          <button @click="open = !open" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm">
            üìã Copy ‚ñæ
          </button>
          <div x-show="open" @click.away="open = false" x-cloak
               class="absolute top-full left-0 mt-1 bg-gray-800 border border-gray-600 rounded shadow-lg z-50 min-w-40">
            <button @click="copyTable(); open = false" class="w-full px-3 py-2 text-left text-sm hover:bg-gray-700">Copy Table</button>
            <button @click="copySelectedRows(); open = false" :disabled="$store.editor.selectedRows.length === 0" 
                    class="w-full px-3 py-2 text-left text-sm hover:bg-gray-700 disabled:opacity-50">Copy Selected</button>
          </div>
        </div>
        <button @click="openPastePad()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm">
          üì• Paste
        </button>
      </div>

      <div class="w-px h-6 bg-gray-600"></div>

      <!-- File Operations -->
      <div class="flex items-center gap-1">
        <button @click="openOpenDialog()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm">
          üìÇ Open
        </button>
        <button @click="openSaveDialog()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm">
          üíæ Save
        </button>
      </div>

      <div class="w-px h-6 bg-gray-600"></div>

      <!-- Hierarchical Column Visibility Menu -->
      <div class="relative" x-data="GDEditNav.hierarchicalColumnMenu()">
        <button @click="toggle()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm flex items-center gap-2">
          üëÅÔ∏è <span x-text="visibleColumnsCount + '/' + totalColumnsCount"></span> ‚ñæ
        </button>
        <div x-show="isOpen" @click.away="close()" x-cloak
             class="absolute top-full left-0 mt-1 bg-gray-800 border border-gray-600 rounded shadow-lg z-50 min-w-64 max-h-80 overflow-y-auto">
          <!-- Search -->
          <div class="p-2 border-b border-gray-600">
            <input type="text" x-model="searchTerm" placeholder="Search columns..."
                   class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs focus:outline-none focus:border-blue-500">
          </div>
          <!-- Global actions -->
          <div class="p-2 border-b border-gray-600 flex gap-2">
            <button @click="showAllColumns()" class="text-xs text-blue-400 hover:underline">Show All</button>
            <button @click="hideAllColumns()" class="text-xs text-blue-400 hover:underline">Hide All</button>
          </div>
          <!-- Hierarchical groups -->
          <template x-for="group in getHierarchy()" :key="group.name">
            <div class="col-menu-group">
              <div class="col-menu-group-header" @click="toggleComponent(group.name)">
                <div class="flex items-center gap-2">
                  <span x-text="isComponentExpanded(group.name) ? '‚ñº' : '‚ñ∂'" class="text-xs text-gray-500"></span>
                  <span x-text="group.name" class="text-sm"></span>
                  <span class="text-xs text-gray-500" x-text="'(' + getComponentVisibleCount(group.name) + '/' + getComponentTotalCount(group.name) + ')'"></span>
                </div>
                <div class="flex gap-1" @click.stop>
                  <button @click="showAllInComponent(group.name)" class="text-xs text-blue-400 hover:text-blue-300 px-1">All</button>
                  <button @click="hideAllInComponent(group.name)" class="text-xs text-gray-400 hover:text-gray-300 px-1">None</button>
                </div>
              </div>
              <div x-show="isComponentExpanded(group.name)" class="col-menu-items">
                <template x-for="col in group.columns" :key="col.id">
                  <label class="flex items-center gap-2 px-3 py-1 hover:bg-gray-700 cursor-pointer">
                    <input type="checkbox" :checked="col.visible" @change="toggleColumn(col.id)" class="rounded">
                    <span x-text="col.id.split('.')[1] || col.id" class="text-xs"></span>
                  </label>
                </template>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Validate -->
      <button @click="validateAll()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm">
        ‚úì Validate
      </button>

      <!-- Search -->
      <div class="flex-1 max-w-lg relative">
        <input 
          type="text" 
          x-model="$store.editor.searchQuery"
          @input="debounceSearch()"
          @keydown.enter="submitSearch()"
          @focus="showSearchHistory = searchHistory.length > 0"
          placeholder="Search... (:Class.prop: value, -[:REL]->: target)"
          class="w-full px-3 py-1.5 bg-gray-700 border border-gray-600 rounded text-sm focus:outline-none focus:border-blue-500 pr-8">
        <button x-show="$store.editor.searchQuery" @click="clearSearch()" 
                class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">‚úï</button>
        
        <!-- Search History Dropdown -->
        <div x-show="showSearchHistory && searchHistory.length > 0" @click.away="showSearchHistory = false" x-cloak
             class="absolute top-full left-0 right-0 mt-1 bg-gray-800 border border-gray-600 rounded shadow-lg z-50 max-h-48 overflow-y-auto">
          <div class="px-2 py-1 text-xs text-gray-500 border-b border-gray-700">Recent searches</div>
          <template x-for="item in searchHistory" :key="item">
            <button @click="selectHistoryItem(item)" class="w-full px-3 py-1.5 text-left text-sm hover:bg-gray-700 truncate" x-text="item"></button>
          </template>
        </div>
      </div>

      <!-- Pagination Info -->
      <div class="text-sm text-gray-400">
        <span x-text="paginationInfo"></span>
      </div>
    </div>

    <!-- Paste Pad Modal -->
    <div x-show="showPastePad" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-gray-800 rounded-lg p-6 w-[600px] max-h-[80vh] overflow-y-auto border border-gray-600" @click.away="closePastePad()">
        <h2 class="text-lg font-bold mb-4">üì• Paste Data</h2>
        <textarea x-model="pasteContent" @input="updatePastePreview()" 
                  placeholder="Paste CSV/TSV data here..."
                  class="w-full h-48 bg-gray-700 border border-gray-600 rounded p-3 text-sm font-mono"></textarea>
        
        <div x-show="pastePreview" class="mt-4 p-3 bg-gray-700 rounded">
          <div class="text-sm text-gray-400 mb-2">
            Detected: <span class="text-white" x-text="pastePreview?.format"></span> ‚Ä¢ 
            <span x-text="pastePreview?.rowCount"></span> rows
          </div>
          <div x-show="pastePreview?.headers" class="text-xs text-gray-500">
            Headers: <span x-text="pastePreview?.headers?.join(', ')"></span>
          </div>
        </div>
        
        <div class="mt-6 flex justify-end gap-3">
          <button @click="closePastePad()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded">Cancel</button>
          <button @click="executePaste()" :disabled="!pasteContent" 
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-600 rounded">Import</button>
        </div>
      </div>
    </div>

    <!-- Open File Dialog -->
    <div x-show="showOpenDialog" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-gray-800 rounded-lg p-6 w-96 border border-gray-600" @click.away="closeOpenDialog()">
        <h2 class="text-lg font-bold mb-4">üìÇ Open File</h2>
        <input type="file" accept=".csv,.tsv,.json" @change="handleFileSelect($event)" 
               class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-sm">
        
        <div x-show="openPreview && !openPreview.error" class="mt-4 p-3 bg-gray-700 rounded text-sm">
          Format: <span class="text-white" x-text="openPreview?.format"></span> ‚Ä¢ 
          <span x-text="openPreview?.rows"></span> rows
          <div x-show="openPreview?.headers" class="text-xs text-gray-500 mt-1">
            Headers: <span x-text="openPreview?.headers?.slice(0, 5).join(', ')"></span>
            <span x-show="openPreview?.headers?.length > 5">...</span>
          </div>
        </div>
        <div x-show="openPreview?.error" class="mt-4 p-3 bg-red-900/50 rounded text-sm text-red-300" x-text="openPreview?.error"></div>
        
        <div class="mt-6 flex justify-end gap-3">
          <button @click="closeOpenDialog()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded">Cancel</button>
          <button @click="importFile()" :disabled="!openFile || openPreview?.error" 
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-600 rounded">Import</button>
        </div>
      </div>
    </div>

    <!-- Save File Dialog -->
    <div x-show="showSaveDialog" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-gray-800 rounded-lg p-6 w-96 border border-gray-600" @click.away="closeSaveDialog()">
        <h2 class="text-lg font-bold mb-4">üíæ Export Data</h2>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-gray-400 mb-1">Filename</label>
            <input type="text" x-model="saveFilename" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Format</label>
            <select x-model="saveFormat" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
              <option value="csv">CSV</option>
              <option value="json">JSON</option>
            </select>
          </div>
          <label class="flex items-center gap-2">
            <input type="checkbox" x-model="exportVisibleOnly" class="rounded">
            <span class="text-sm">Export visible class only</span>
          </label>
        </div>
        
        <div class="mt-6 flex justify-end gap-3">
          <button @click="closeSaveDialog()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded">Cancel</button>
          <button @click="exportData()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded">Export</button>
        </div>
      </div>
    </div>

    <!-- Validation Panel -->
    <div x-show="showValidationPanel" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-gray-800 rounded-lg p-6 w-[600px] max-h-[80vh] overflow-y-auto border border-gray-600" @click.away="closeValidationPanel()">
        <h2 class="text-lg font-bold mb-4">‚ö†Ô∏è Validation Errors</h2>
        <div class="space-y-3">
          <template x-for="item in validationSummary" :key="item.instanceId">
            <div class="p-3 bg-gray-700 rounded">
              <div class="font-medium text-red-400" x-text="item.instanceId + ' (' + item.instanceClass + ')'"></div>
              <ul class="mt-2 text-sm text-gray-300 list-disc list-inside">
                <template x-for="err in item.errors" :key="err.field + err.message">
                  <li><span class="text-gray-400" x-text="err.field + ': '"></span><span x-text="err.message"></span></li>
                </template>
              </ul>
            </div>
          </template>
        </div>
        <div class="mt-6 flex justify-end">
          <button @click="closeValidationPanel()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Data Table -->
  <main class="p-4 flex-1 overflow-y-auto">
    <div x-data="{ ...dataTable(), ...GDEditNav.columnManager() }" x-init="init()" class="overflow-x-auto bg-gray-800 rounded-lg border border-gray-700">
      <table class="w-full text-sm">
        <thead class="bg-gray-750 border-b border-gray-600">
          <tr>
            <th class="w-10 px-2 py-2">
              <input type="checkbox" @change="toggleSelectAll($event)" class="rounded">
            </th>
            <!-- Frozen _id column -->
            <th class="px-3 py-2 text-left font-medium text-gray-300 relative frozen-col cursor-pointer select-none" 
                :style="getColumnStyle('_id')"
                @click="toggleSort('_id')">
              <div class="flex items-center gap-1">
                <span>_id</span>
                <span class="sort-indicator" x-text="getSortIcon('_id')"></span>
                <span x-show="isFrozen('_id')" class="text-xs text-blue-400">‚ùÑ</span>
              </div>
              <div class="resize-handle" @mousedown.stop="startResize($event, '_id')"></div>
            </th>
            <!-- Frozen _class column -->
            <th class="px-3 py-2 text-left font-medium text-gray-300 relative frozen-col frozen-col-class cursor-pointer select-none" 
                :style="getColumnStyle('_class')"
                @click="toggleSort('_class')">
              <div class="flex items-center gap-1">
                <span>_class</span>
                <span class="sort-indicator" x-text="getSortIcon('_class')"></span>
                <span x-show="isFrozen('_class')" class="text-xs text-blue-400">‚ùÑ</span>
              </div>
              <div class="resize-handle" @mousedown.stop="startResize($event, '_class')"></div>
            </th>
            <!-- Dynamic columns with sorting, reordering -->
            <template x-for="col in visibleColumns()" :key="col.id">>
              <th class="px-3 py-2 text-left font-medium text-gray-300 whitespace-nowrap relative group cursor-pointer select-none" 
                  :style="getColumnStyle(col.id)"
                  :class="{ 'dragging-over': dragOverColumn === col.id }"
                  draggable="true"
                  @dragstart="startDrag($event, col.id)"
                  @dragover="onDragOver($event, col.id)"
                  @dragleave="onDragLeave()"
                  @drop="onDrop($event, col.id)"
                  @dragend="onDragEnd()"
                  @click="toggleSort(col.id)">
                <div class="flex items-center gap-1">
                  <span class="cursor-move text-gray-500 text-xs mr-1">‚ãÆ‚ãÆ</span>
                  <span x-text="col.id"></span>
                  <span class="sort-indicator" x-text="getSortIcon(col.id)"></span>
                  <span x-show="isFrozen(col.id)" class="text-xs text-blue-400">‚ùÑ</span>
                </div>
                <div class="absolute right-6 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 flex gap-1">
                  <button @click.stop="toggleFreeze(col.id)" class="text-xs px-1 hover:text-blue-400" title="Toggle freeze">
                    ‚ùÑ
                  </button>
                  <button @click.stop="autoFitColumn(col.id)" class="text-xs px-1 text-blue-400" title="Auto-fit width">‚ü∑</button>
                </div>
                <div class="resize-handle" @mousedown.stop="startResize($event, col.id)"></div>
              </th>
            </template>
            <th class="px-3 py-2 text-left font-medium text-gray-300">Relations</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(instance, idx) in paginatedInstances()" :key="instance._id">
            <tr class="border-b border-gray-700 hover:bg-gray-750" 
                :class="isSelected(instance._id) ? 'bg-blue-900/30' : ''">
              <td class="px-2 py-1">
                <input type="checkbox" :checked="isSelected(instance._id)" @change="toggleSelect(instance._id)" class="rounded">
              </td>
              <td class="px-3 py-1 font-mono text-blue-400" :style="getColumnStyle('_id')" x-text="instance._id"></td>
              <td class="px-3 py-1" :style="getColumnStyle('_class')">
                <span class="px-2 py-0.5 bg-purple-600/30 text-purple-300 rounded text-xs" x-text="instance._class"></span>
              </td>
              <template x-for="col in visibleColumns()" :key="col.id">
                <td class="px-3 py-1" :style="getColumnStyle(col.id)" x-data="cellWidget(instance, col)">
                  <!-- Boolean -->
                  <template x-if="col.type === 'bool' || col.type === 'boolean'">
                    <input type="checkbox" :checked="getValue()" @change="setValue($event.target.checked)" class="rounded">
                  </template>
                  
                  <!-- String -->
                  <template x-if="col.type === 'string'">
                    <input type="text" :value="getValue()" @blur="setValue($event.target.value)" 
                           :class="validationClass" :title="validationTitle"
                           class="w-full bg-transparent border border-transparent hover:border-gray-600 focus:border-blue-500 rounded px-2 py-0.5 focus:outline-none">
                  </template>
                  
                  <!-- Integer -->
                  <template x-if="col.type === 'int' || col.type === 'integer'">
                    <div x-data="integerWidgetData()" x-init="initInteger()" class="flex items-center gap-1">
                      <button @click="decrement()" class="px-1 text-gray-400 hover:text-white">‚àí</button>
                      <input type="number" step="1" x-model.number="localValue" @blur="validateAndSet($event.target.value)"
                             :class="validationClass" :title="validationTitle"
                             class="w-full bg-transparent border border-transparent hover:border-gray-600 focus:border-blue-500 rounded px-2 py-0.5 focus:outline-none text-center">
                      <button @click="increment()" class="px-1 text-gray-400 hover:text-white">+</button>
                    </div>
                  </template>
                  
                  <!-- Float/Double/Number -->
                  <template x-if="col.type === 'float' || col.type === 'double' || col.type === 'number'">
                    <input type="number" step="0.01" :value="getValue()" @blur="setValue(parseFloat($event.target.value) || 0)" 
                           :class="validationClass" :title="validationTitle"
                           class="w-full bg-transparent border border-transparent hover:border-gray-600 focus:border-blue-500 rounded px-2 py-0.5 focus:outline-none">
                  </template>
                  
                  <!-- Number with Slider -->
                  <template x-if="col.type === 'slider' || col.schema?.widget === 'slider'">
                    <div x-data="sliderWidgetData()" x-init="initSlider()" class="flex items-center gap-2 w-full">
                      <div class="slider-track flex-1" @click="updateFromClick($event)">
                        <div class="slider-fill" :style="`width: ${percentage}%`"></div>
                        <div class="slider-thumb" :style="`left: ${percentage}%`"></div>
                      </div>
                      <input type="range" :min="min" :max="max" :step="step" x-model="localValue" @input="updateValue($event.target.value)"
                             class="hidden">
                      <span class="text-xs text-gray-400 w-10 text-right" x-text="localValue"></span>
                    </div>
                  </template>
                  
                  <!-- Enum Dropdown -->
                  <template x-if="col.type === 'enum' || col.schema?.enum">
                    <div x-data="enumWidgetData()" x-init="initEnum()" class="relative">
                      <button @click="toggle()" class="enum-btn">
                        <span x-text="localValue || '‚Äî select ‚Äî'" :class="localValue ? 'text-white' : 'text-gray-500'"></span>
                        <span class="text-gray-400">‚ñæ</span>
                      </button>
                      <div x-show="isOpen" @click.away="isOpen = false" x-cloak class="widget-dropdown">
                        <input x-show="options.length > 5" type="text" x-model="searchTerm" placeholder="Search..." 
                               class="dropdown-search">
                        <template x-for="opt in filteredOptions" :key="opt">
                          <div @click="selectOption(opt)" class="widget-dropdown-item" 
                               :class="opt === localValue ? 'bg-blue-600/30 text-blue-300' : ''" x-text="opt"></div>
                        </template>
                        <div x-show="filteredOptions.length === 0" class="px-3 py-2 text-gray-500 text-sm">No options</div>
                      </div>
                    </div>
                  </template>
                  
                  <!-- Date -->
                  <template x-if="col.type === 'date'">
                    <input type="date" :value="formatDate(getValue())" @change="setValue($event.target.value)"
                           :class="validationClass" :title="validationTitle"
                           class="bg-transparent border border-transparent hover:border-gray-600 focus:border-blue-500 rounded px-2 py-0.5 focus:outline-none">
                  </template>
                  
                  <!-- Color Picker -->
                  <template x-if="col.type === 'color'">
                    <div x-data="colorWidgetData()" x-init="initColor()" class="relative flex items-center gap-2">
                      <div class="color-swatch" :style="`background-color: ${localValue}`" @click="isOpen = !isOpen"></div>
                      <span class="text-xs font-mono text-gray-300" x-text="localValue"></span>
                      <div x-show="isOpen" @click.away="isOpen = false" x-cloak class="color-popup">
                        <input type="color" :value="localValue" @input="updateColor($event.target.value)">
                        <div x-show="recentColors.length > 0" class="recent-colors">
                          <template x-for="c in recentColors" :key="c">
                            <div class="recent-color" :style="`background-color: ${c}`" @click="selectRecent(c)"></div>
                          </template>
                        </div>
                      </div>
                    </div>
                  </template>
                  
                  <!-- Vector 2/3/4 -->
                  <template x-if="['vector2', 'vector3', 'vector4', 'vec2', 'vec3', 'vec4'].includes(col.type)">
                    <div x-data="vectorWidgetData()" x-init="initVector()">
                      <template x-if="!isExpanded">
                        <button @click="toggleExpanded()" class="expand-btn" x-text="'(' + displayValue + ')'"></button>
                      </template>
                      <template x-if="isExpanded">
                        <div class="flex items-center gap-2 flex-wrap">
                          <template x-for="(comp, i) in components" :key="i">
                            <div class="vector-field">
                              <span class="vector-label" x-text="labels[i]"></span>
                              <input type="number" step="0.1" :value="comp" @blur="updateComponent(i, $event.target.value)" class="vector-input">
                            </div>
                          </template>
                          <button @click="toggleExpanded()" class="text-gray-400 hover:text-white text-sm">‚úì</button>
                        </div>
                      </template>
                    </div>
                  </template>
                  
                  <!-- String Array / Tags -->
                  <template x-if="col.type === 'string[]' || col.type === 'tags'">
                    <div x-data="tagsWidgetData()" x-init="initTags()" class="flex flex-wrap items-center gap-1">
                      <template x-for="(tag, i) in tags" :key="i">
                        <span class="tag-pill">
                          <span x-text="tag"></span>
                          <span @click="removeTag(i)" class="tag-remove">√ó</span>
                        </span>
                      </template>
                      <template x-if="isEditing">
                        <div class="relative">
                          <input type="text" x-model="inputValue" @keydown="handleKeydown($event)" 
                                 @blur="setTimeout(() => { if (!pendingTag) { addTag(); isEditing = false; } }, 150)"
                                 x-ref="tagInput" class="tag-input" placeholder="Add...">
                          <div x-show="filteredSuggestions.length > 0" class="widget-dropdown" style="min-width: 120px;">
                            <template x-for="sug in filteredSuggestions" :key="sug">
                              <div @mousedown.prevent="pendingTag = true; addTag(sug); isEditing = false; pendingTag = false" 
                                   class="widget-dropdown-item" x-text="sug"></div>
                            </template>
                          </div>
                        </div>
                      </template>
                      <button x-show="!isEditing" @click="isEditing = true; $nextTick(() => $refs.tagInput?.focus())" 
                              class="text-blue-400 hover:text-blue-300 text-sm font-bold">+</button>
                    </div>
                  </template>
                  
                  <!-- Array (Expandable) -->
                  <template x-if="col.type === 'array' && col.type !== 'string[]'">
                    <div x-data="arrayWidgetData()" x-init="initArray()">
                      <button @click="toggleExpanded()" class="expand-btn" x-text="preview"></button>
                      <div x-show="isExpanded" x-cloak class="nested-container">
                        <template x-for="(item, i) in items" :key="i">
                          <div class="flex items-center gap-2 py-1 border-b border-gray-600" style="border-color: #374151;">
                            <span class="text-xs text-gray-500 w-6" x-text="i"></span>
                            <template x-if="editIndex === i">
                              <input type="text" x-model="editValue" @blur="saveEdit()" @keydown.enter="saveEdit()" @keydown.escape="cancelEdit()"
                                     class="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-white focus:outline-none focus:border-blue-500">
                            </template>
                            <template x-if="editIndex !== i">
                              <span @dblclick="startEdit(i)" class="flex-1 text-xs truncate cursor-pointer text-gray-300 hover:text-white" 
                                    x-text="typeof item === 'object' ? JSON.stringify(item) : item"></span>
                            </template>
                            <div class="flex gap-1">
                              <button @click="moveUp(i)" :disabled="i === 0" class="text-xs text-gray-400 hover:text-white disabled:opacity-30">‚Üë</button>
                              <button @click="moveDown(i)" :disabled="i === items.length - 1" class="text-xs text-gray-400 hover:text-white disabled:opacity-30">‚Üì</button>
                              <button @click="removeItem(i)" class="text-xs text-red-400 hover:text-red-300">√ó</button>
                            </div>
                          </div>
                        </template>
                        <button @click="addItem()" class="mt-2 text-xs text-blue-400 hover:text-blue-300">+ Add item</button>
                      </div>
                    </div>
                  </template>
                  
                  <!-- Nested Object -->
                  <template x-if="col.type === 'object' || col.type === 'json'">
                    <div x-data="objectWidgetData()" x-init="initObject()">
                      <button @click="toggleExpanded()" class="expand-btn">
                        <span x-text="preview"></span>
                        <span style="color: #6b7280; margin-left: 4px;" x-text="'(' + keyCount + ' keys)'"></span>
                      </button>
                      <div x-show="isExpanded" x-cloak class="nested-container">
                        <template x-if="!editMode">
                          <div>
                            <template x-for="(val, key) in data" :key="key">
                              <div class="flex items-center gap-2 py-1" style="border-bottom: 1px solid #374151;">
                                <span class="text-xs font-mono" style="color: #c4b5fd; min-width: 60px;" x-text="key + ':'"></span>
                                <input type="text" :value="typeof val === 'object' ? JSON.stringify(val) : val" 
                                       @blur="updateProperty(key, $event.target.value)"
                                       class="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs text-white focus:outline-none focus:border-blue-500">
                                <button @click="deleteProperty(key)" class="text-red-400 hover:text-red-300 text-sm">√ó</button>
                              </div>
                            </template>
                            <div class="flex gap-3 mt-3">
                              <button @click="addProperty()" class="text-xs text-blue-400 hover:text-blue-300">+ Add key</button>
                              <button @click="startEdit()" class="text-xs text-gray-400 hover:text-white">Edit JSON</button>
                            </div>
                          </div>
                        </template>
                        <template x-if="editMode">
                          <div>
                            <textarea x-model="jsonText" class="w-full h-32 bg-gray-700 border border-gray-600 rounded p-2 text-xs font-mono text-white focus:outline-none focus:border-blue-500"></textarea>
                            <div x-show="parseError" class="text-xs text-red-400 mt-1" x-text="parseError"></div>
                            <div class="flex gap-3 mt-2">
                              <button @click="saveEdit()" class="text-xs text-green-400 hover:text-green-300">Save</button>
                              <button @click="cancelEdit()" class="text-xs text-gray-400 hover:text-white">Cancel</button>
                            </div>
                          </div>
                        </template>
                      </div>
                    </div>
                  </template>
                  
                  <!-- Entity Reference -->
                  <template x-if="col.type === 'entity' || col.type === 'entityRef'">
                    <div x-data="entityRefWidgetData()" x-init="initEntityRef()" class="relative">
                      <template x-if="localValue">
                        <div class="flex items-center gap-2">
                          <span class="entity-badge">
                            <span x-text="localValue"></span>
                            <span x-show="selectedEntity" class="opacity-60" x-text="'(' + (selectedEntity?._class || '') + ')'"></span>
                          </span>
                          <button @click="clearSelection()" class="text-gray-400 hover:text-red-400 text-sm">√ó</button>
                          <button @click="toggle()" class="text-gray-400 hover:text-white text-sm">‚úé</button>
                        </div>
                      </template>
                      <template x-if="!localValue">
                        <button @click="toggle()" class="select-entity-btn">Select entity...</button>
                      </template>
                      <div x-show="isOpen" @click.away="isOpen = false" x-cloak class="widget-dropdown" style="width: 280px;">
                        <div class="p-2 border-b border-gray-600" style="background: #374151;">
                          <input type="text" x-model="searchTerm" placeholder="Search entities..." 
                                 class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-sm focus:outline-none focus:border-blue-500">
                          <select x-model="filterClass" class="mt-2 w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-sm">
                            <option value="">All classes</option>
                            <template x-for="cls in availableClasses" :key="cls">
                              <option :value="cls" x-text="cls"></option>
                            </template>
                          </select>
                        </div>
                        <template x-if="recentSelections.length > 0 && !searchTerm">
                          <div class="p-2 border-b border-gray-600">
                            <div class="text-xs text-gray-500 mb-1">Recent</div>
                            <template x-for="id in recentSelections.slice(0, 3)" :key="id">
                              <div @click="selectEntity({_id: id})" class="widget-dropdown-item text-xs" x-text="id"></div>
                            </template>
                          </div>
                        </template>
                        <div class="max-h-32 overflow-y-auto">
                          <template x-for="entity in filteredEntities" :key="entity._id">
                            <div @click="selectEntity(entity)" class="widget-dropdown-item flex items-center justify-between">
                              <span class="text-xs" x-text="entity._id"></span>
                              <span class="text-xs text-purple-400" x-text="entity._class"></span>
                            </div>
                          </template>
                        </div>
                      </div>
                    </div>
                  </template>
                  
                  <!-- Relation Editor -->
                  <template x-if="col.type === 'relation'">
                    <div x-data="relationWidgetData()" x-init="initRelation()" class="relative">
                      <div class="flex flex-wrap items-center gap-1">
                        <template x-for="(target, i) in targets" :key="i">
                          <span class="relation-pill">
                            <span x-text="target._to"></span>
                            <span x-show="Object.keys(target).length > 1" @click="editQualifier(i)" 
                                  class="text-green-500 cursor-pointer" title="Edit qualifiers">‚öô</span>
                            <span @click="removeTarget(i)" class="hover:text-red-400 cursor-pointer">√ó</span>
                          </span>
                        </template>
                        <button @click="isOpen = !isOpen" class="text-xs text-gray-400 hover:text-white">+ Add</button>
                      </div>
                      <div x-show="isOpen" @click.away="isOpen = false" x-cloak class="widget-dropdown w-56">
                        <input type="text" x-model="searchTerm" placeholder="Search targets..." 
                               class="w-full px-3 py-2 bg-gray-700 border-b border-gray-600 text-xs focus:outline-none">
                        <div class="max-h-32 overflow-y-auto">
                          <template x-for="entity in filteredEntities" :key="entity._id">
                            <div @click="addTarget(entity)" class="widget-dropdown-item flex items-center justify-between">
                              <span class="text-xs" x-text="entity._id"></span>
                              <span class="text-xs text-gray-500" x-text="entity._class"></span>
                            </div>
                          </template>
                        </div>
                      </div>
                      <!-- Qualifier Editor Modal -->
                      <div x-show="editingQualifier !== null" x-cloak 
                           class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                        <div class="bg-gray-800 rounded-lg p-4 w-80 border border-gray-600" @click.away="editingQualifier = null">
                          <h3 class="font-bold mb-3">Edit Qualifiers</h3>
                          <template x-for="(val, key) in qualifiers" :key="key">
                            <div class="flex items-center gap-2 mb-2">
                              <span class="text-xs text-gray-400 w-16" x-text="key + ':'"></span>
                              <input type="text" x-model="qualifiers[key]" class="flex-1 bg-gray-700 rounded px-2 py-1 text-xs">
                              <button @click="removeQualifierField(key)" class="text-xs text-red-400">√ó</button>
                            </div>
                          </template>
                          <button @click="addQualifierField()" class="text-xs text-blue-400 mb-3">+ Add qualifier</button>
                          <div class="flex justify-end gap-2">
                            <button @click="editingQualifier = null" class="px-3 py-1 bg-gray-600 rounded text-xs">Cancel</button>
                            <button @click="saveQualifier()" class="px-3 py-1 bg-blue-600 rounded text-xs">Save</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </template>
                  
                  <!-- Default fallback for unknown types -->
                  <template x-if="!['bool','boolean','string','int','integer','float','double','number','slider','enum','date','color','vector2','vector3','vector4','vec2','vec3','vec4','string[]','tags','array','object','json','entity','entityRef','relation'].includes(col.type) && !col.schema?.enum && col.schema?.widget !== 'slider'">
                    <input type="text" :value="getValue()" @blur="setValue($event.target.value)" 
                           class="w-full bg-transparent border border-transparent hover:border-gray-600 focus:border-blue-500 rounded px-2 py-0.5 focus:outline-none">
                  </template>
                </td>
              </template>
              <td class="px-3 py-1">
                <template x-if="instance.relations && Object.keys(instance.relations).length > 0">
                  <div class="flex flex-wrap gap-1">
                    <template x-for="(targets, relName) in instance.relations" :key="relName">
                      <span class="px-1.5 py-0.5 bg-gray-700 text-xs rounded" 
                            x-text="relName + ': ' + targets.length"></span>
                    </template>
                  </div>
                </template>
                <template x-if="!instance.relations || Object.keys(instance.relations).length === 0">
                  <span class="text-gray-500 text-xs">‚Äî</span>
                </template>
              </td>
            </tr>
          </template>
          <tr x-show="paginatedInstances().length === 0">
            <td colspan="100" class="px-4 py-8 text-center text-gray-500">
              No data found
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div x-data="pagination()" class="mt-4 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <button @click="goToFirst()" :disabled="currentPage === 1" 
                class="px-2 py-1 bg-gray-700 hover:bg-gray-600 disabled:opacity-50 rounded">‚óÄ‚óÄ</button>
        <button @click="goToPrev()" :disabled="currentPage === 1"
                class="px-2 py-1 bg-gray-700 hover:bg-gray-600 disabled:opacity-50 rounded">‚óÄ</button>
        <span class="px-3 text-sm">
          Page <input type="number" x-model.number="inputPage" @change="goToPage(inputPage)" 
                      class="w-16 bg-gray-700 rounded px-2 py-0.5 text-center mx-1"> 
          of <span x-text="totalPages"></span>
        </span>
        <button @click="goToNext()" :disabled="currentPage === totalPages"
                class="px-2 py-1 bg-gray-700 hover:bg-gray-600 disabled:opacity-50 rounded">‚ñ∂</button>
        <button @click="goToLast()" :disabled="currentPage === totalPages"
                class="px-2 py-1 bg-gray-700 hover:bg-gray-600 disabled:opacity-50 rounded">‚ñ∂‚ñ∂</button>
      </div>
      <div class="text-sm text-gray-400">
        Showing <span x-text="startIndex + 1"></span>-<span x-text="Math.min(endIndex, totalItems)"></span> 
        of <span x-text="totalItems"></span> entities
      </div>
    </div>
  </main>

  <!-- Add Row Modal -->
  <div x-data="addModal()" x-init="init()" x-show="showAddModal" x-cloak 
       class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-96 border border-gray-600" @click.away="showAddModal = false">
      <h2 class="text-lg font-bold mb-4">Add New Row</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm text-gray-400 mb-1">Class</label>
          <select x-model="newClass" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
            <option value="">Select class...</option>
            <template x-for="cls in $store.editor.classes" :key="cls">
              <option :value="cls" x-text="cls" :selected="cls === $store.editor.selectedClass"></option>
            </template>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-400 mb-1">ID</label>
          <input type="text" x-model="newId" placeholder="unique-identifier"
                 class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
        </div>
      </div>
      <div class="mt-6 flex justify-end gap-3">
        <button @click="showAddModal = false" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded">Cancel</button>
        <button @click="createRow()" :disabled="!newClass || !newId" 
                class="px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-600 rounded">Create</button>
      </div>
    </div>
  </div>

  <!-- Bulk Add Modal -->
  <div x-data="bulkAddModal()" x-init="init()">
    <div x-show="showBulkAddModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-gray-800 rounded-lg p-6 w-[500px] max-h-[80vh] overflow-y-auto border border-gray-600" @click.away="close()">
        <h2 class="text-lg font-bold mb-4">‚ûï Bulk Add Rows</h2>
        
        <div class="space-y-4">
          <!-- Class Selection -->
          <div>
            <label class="block text-sm text-gray-400 mb-1">Class</label>
            <select x-model="selectedClass" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
              <option value="">Select class...</option>
              <template x-for="cls in $store.editor.classes" :key="cls">
                <option :value="cls" x-text="cls"></option>
              </template>
            </select>
          </div>
          
          <!-- Row Count -->
          <div>
            <label class="block text-sm text-gray-400 mb-1">Number of Rows</label>
            <div class="flex gap-2 flex-wrap">
              <template x-for="count in presetCounts" :key="count">
                <button @click="selectPreset(count)" 
                        :class="!useCustomCount && rowCount === count ? 'bg-blue-600' : 'bg-gray-700'"
                        class="px-3 py-1 rounded text-sm hover:bg-blue-500" x-text="count"></button>
              </template>
              <button @click="useCustomCount = true" 
                      :class="useCustomCount ? 'bg-blue-600' : 'bg-gray-700'"
                      class="px-3 py-1 rounded text-sm hover:bg-blue-500">Custom</button>
            </div>
            <input x-show="useCustomCount" type="number" x-model.number="customCount" min="1" max="1000" 
                   class="mt-2 w-24 bg-gray-700 border border-gray-600 rounded px-3 py-1">
          </div>
          
          <!-- Name Template -->
          <div>
            <label class="block text-sm text-gray-400 mb-1">Name Template</label>
            <input type="text" x-model="nameTemplate" placeholder="$t-$i"
                   class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 font-mono">
            <p class="text-xs text-gray-500 mt-1">$t = class name, $i = index (padded)</p>
          </div>
          
          <!-- Start Index -->
          <div>
            <label class="block text-sm text-gray-400 mb-1">Start Index</label>
            <input type="number" x-model.number="startIndex" min="0"
                   class="w-24 bg-gray-700 border border-gray-600 rounded px-3 py-2">
          </div>
          
          <!-- Preview -->
          <div x-show="generatedIds.length > 0">
            <label class="block text-sm text-gray-400 mb-1">Preview (<span x-text="generatedIds.length"></span> IDs)</label>
            <div class="bg-gray-700 rounded p-2 max-h-32 overflow-y-auto font-mono text-xs">
              <template x-for="(id, i) in generatedIds.slice(0, 10)" :key="i">
                <div class="py-0.5" x-text="id"></div>
              </template>
              <div x-show="generatedIds.length > 10" class="text-gray-500">... and <span x-text="generatedIds.length - 10"></span> more</div>
            </div>
          </div>
        </div>
        
        <div class="mt-6 flex justify-end gap-3">
          <button @click="close()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded">Cancel</button>
          <button @click="createRows()" :disabled="!selectedClass || generatedIds.length === 0 || isCreating" 
                  class="px-4 py-2 bg-green-600 hover:bg-green-500 disabled:bg-gray-600 rounded">
            <span x-show="!isCreating">Create <span x-text="generatedIds.length"></span> Rows</span>
            <span x-show="isCreating">Creating...</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Bar -->
  <footer class="flex-shrink-0 bg-gray-800 border-t border-gray-700 px-4 py-1 text-xs flex items-center gap-4">
    <span class="flex items-center gap-1">
      <span class="w-2 h-2 rounded-full" :class="connected ? 'bg-green-500' : 'bg-red-500'"></span>
      <span x-text="connected ? 'Connected' : 'Disconnected'"></span>
    </span>
    <span class="text-gray-500">|</span>
    <span x-text="$store.editor.instances.length + ' entities loaded'"></span>
    <span class="text-gray-500">|</span>
    <span x-show="$store.editor.selectedRows.length > 0" x-text="$store.editor.selectedRows.length + ' selected'"></span>
  </footer>

    </div><!-- End Main Content Area -->

    <!-- Chat Sidebar -->
    <aside x-data="chatSidebar()" x-init="init()" x-show="$store.chat?.isOpen" x-cloak
           class="chat-sidebar w-96 flex-shrink-0 border-l border-gray-700 bg-gray-850 flex flex-col h-screen">
      
      <!-- Chat Tabs -->
      <div x-data="chatTabs()" class="chat-tabs flex-shrink-0 bg-gray-800 border-b border-gray-700 px-2 py-1.5">
        <div class="flex items-center gap-1 overflow-x-auto">
          <template x-for="tab in tabs" :key="tab.id">
            <div class="flex items-center">
              <button @click="setActiveTab(tab.id)"
                      :class="isActive(tab.id) ? 'bg-gray-700 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-750'"
                      class="px-3 py-1 rounded-t text-sm flex items-center gap-1 whitespace-nowrap">
                <span x-text="tab.name"></span>
                <span x-show="canClose(tab.id)" @click.stop="closeTab(tab.id)" 
                      class="ml-1 hover:text-red-400 text-xs">√ó</span>
              </button>
            </div>
          </template>
          <button @click="createNewTab()" class="px-2 py-1 text-gray-400 hover:text-white text-sm" title="New Chat">
            +
          </button>
        </div>
      </div>

      <!-- Chat History -->
      <div x-data="chatHistory()" x-init="init()" @scroll="handleScroll($event)" 
           class="chat-history flex-1 overflow-y-auto p-4 flex flex-col">
        
        <!-- Title Card (shown for new chats) -->
        <template x-if="isNew && messages.length === 0">
          <div x-data="chatTitleCard()" class="chat-title-card text-center py-6">
            <pre class="text-blue-400 text-xs leading-tight font-mono mb-4" x-text="logo"></pre>
            <p class="text-gray-400 text-sm mb-4">Your AI-powered assistant for game data editing</p>
            <ul class="text-left text-gray-500 text-sm space-y-2 max-w-xs mx-auto">
              <template x-for="tip in tips" :key="tip">
                <li class="flex items-start gap-2">
                  <span class="text-blue-400">‚Ä¢</span>
                  <span x-text="tip"></span>
                </li>
              </template>
            </ul>
          </div>
        </template>



        <!-- Messages container with space-y -->
        <div class="space-y-4 flex-1">
          <!-- Tool Call Cards -->
          <template x-for="msg in messages" :key="msg.id">
            <div x-data="chatMessageCard(msg)" class="chat-message"
                 :class="getMessageClasses()">
              
              <!-- User Message -->
              <template x-if="isUser">
                <div class="flex justify-end">
                  <div class="chat-bubble-user bg-gray-700 rounded-lg px-4 py-2 max-w-[85%]">
                    <p class="text-sm whitespace-pre-wrap" x-text="message.content"></p>
                    <div class="flex justify-end gap-2 mt-2 opacity-0 hover:opacity-100 transition-opacity">
                      <button @click="copyMessage(message.content)" class="text-xs text-gray-400 hover:text-white">Copy</button>
                      <button @click="editMessage(message.id)" class="text-xs text-gray-400 hover:text-white">Edit</button>
                      <button @click="rollbackTo(message.id)" class="text-xs text-gray-400 hover:text-white">Rollback</button>
                    </div>
                  </div>
                </div>
              </template>

              <!-- Assistant Message -->
              <template x-if="isAssistant">
                <div class="chat-bubble-assistant">
                  <div class="prose prose-invert prose-sm max-w-none markdown-content" x-html="renderMarkdown(message.content)"></div>
                  <div class="text-xs text-gray-500 mt-1" x-text="timestamp"></div>
                </div>
              </template>

              <!-- Tool Call Card -->
              <template x-if="isToolCall">
                <div class="chat-bubble-tool bg-gray-800 border border-gray-700 rounded-lg px-3 py-2">
                  <div class="flex items-center gap-2 text-xs text-yellow-400">
                    <span>üîß</span>
                    <span class="font-mono" x-text="message.toolName"></span>
                  </div>
                  <div x-show="message.arguments" class="mt-1 text-xs text-gray-400 font-mono truncate" x-text="JSON.stringify(message.arguments)"></div>
                </div>
              </template>

              <!-- Tool Result Card -->
              <template x-if="isToolResult">
                <div class="chat-bubble-tool-result bg-gray-800/50 border border-gray-700 rounded-lg px-3 py-2">
                  <div class="flex items-center gap-2 text-xs" :class="message.status === 'success' ? 'text-green-400' : 'text-red-400'">
                    <span x-text="message.status === 'success' ? '‚úì' : '‚úó'"></span>
                    <span class="font-mono" x-text="message.toolName + ' result'"></span>
                  </div>
                  <pre x-show="message.content" class="mt-1 text-xs text-gray-300 font-mono overflow-x-auto max-h-32 overflow-y-auto" x-text="message.content"></pre>
                </div>
              </template>

              <!-- Log/Info Card -->
              <template x-if="isLog">
                <div class="chat-bubble-log text-xs text-gray-500 flex items-center gap-1">
                  <span x-text="message.level === 'info' ? '‚ÑπÔ∏è' : message.level === 'warn' ? '‚ö†Ô∏è' : 'üî¥'"></span>
                  <span class="font-mono" x-text="message.content"></span>
                </div>
              </template>

              <!-- Perf Card -->
              <template x-if="isPerf">
                <div class="chat-bubble-perf text-xs text-gray-600 font-mono">
                  ‚è±Ô∏è <span x-text="message.label"></span>: <span x-text="formatPerfStats(message.stats)"></span>
                </div>
              </template>

              <!-- Error Message -->
              <template x-if="isError">
                <div class="chat-bubble-error bg-red-900/30 border border-red-800 rounded-lg px-4 py-2">
                  <p class="text-sm text-red-300" x-text="message.content"></p>
                </div>
              </template>
            </div>
          </template>
        </div>

        <!-- Ellipsis (loading indicator) -->
        <template x-if="isWaiting">
          <div x-data="chatEllipsis()" x-init="init()" @destroy="destroy()" class="chat-ellipsis mt-4">
            <div class="flex items-center gap-1 text-gray-400">
              <span class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
              <span class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
              <span class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
            </div>
          </div>
        </template>

        <!-- Spacer to push getting started to bottom -->
        <div class="flex-1"></div>

        <!-- Getting Started (shown for new chats) - pinned to bottom -->
        <template x-if="isNew && messages.length === 0">
          <div x-data="chatGettingStarted()" class="chat-getting-started pt-4">
            <p class="text-gray-500 text-xs mb-3">Try one of these:</p>
            <div class="space-y-2">
              <template x-for="prompt in prompts" :key="prompt.text">
                <button @click="usePrompt(prompt)" 
                        class="w-full text-left px-3 py-2 bg-gray-800 hover:bg-gray-750 rounded-lg text-sm border border-gray-700 transition-colors">
                  <span x-text="prompt.icon" class="mr-2"></span>
                  <span x-text="prompt.text" class="text-gray-300"></span>
                </button>
              </template>
            </div>
          </div>
        </template>
      </div>

      <!-- Chat Input Area -->
      <div x-data="chatInput()" x-init="init()" class="chat-input-area flex-shrink-0 border-t border-gray-700 bg-gray-800 p-3">
        
        <!-- Attached Files -->
        <template x-if="attachedFiles.length > 0">
          <div class="flex flex-wrap gap-2 mb-2">
            <template x-for="(file, idx) in attachedFiles" :key="idx">
              <span class="inline-flex items-center gap-1 px-2 py-1 bg-gray-700 rounded text-xs">
                üìé <span x-text="file.name"></span>
                <button @click="removeFile(idx)" class="text-gray-400 hover:text-red-400">√ó</button>
              </span>
            </template>
          </div>
        </template>

        <!-- Agent Pill (when @agent is parsed) -->
        <template x-if="showAgentPill">
          <div class="mb-2">
            <span class="inline-flex items-center gap-1 px-2 py-1 bg-purple-600/30 text-purple-300 rounded text-sm">
              @<span x-text="selectedAgent"></span>
              <button @click="removeAgentPill()" class="hover:text-red-400">√ó</button>
            </span>
          </div>
        </template>

        <!-- Text Input & Submit -->
        <div class="flex gap-2">
          <textarea x-model="inputText" @input="handleInput($event)" 
                    @keydown.enter="if (!$event.shiftKey) { $event.preventDefault(); submit(); }"
                    placeholder="Type a message... (use @agent to select template)"
                    rows="2"
                    class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm resize-none focus:outline-none focus:border-blue-500"></textarea>
          
          <template x-if="!isWaiting">
            <button @click="submit()" :disabled="!inputText.trim()"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg text-sm font-medium">
              Send
            </button>
          </template>
          
          <template x-if="isWaiting">
            <button @click="abort()" 
                    class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-sm font-medium">
              ‚èπ Stop
            </button>
          </template>
        </div>

        <!-- Control Buttons Row (below input) -->
        <div class="flex items-center gap-2 mt-2">
          <!-- Attach File -->
          <button @click="attachFile()" class="p-1 text-gray-400 hover:text-white" title="Attach file">
            üìé
          </button>
        </div>
      </div>
    </aside>

  </div><!-- End Main Layout Container -->

  <script src="/js/components/utils.js"></script>
  <script src="/js/components/toolbar.js"></script>
  <script src="/js/components/clipboard.js"></script>
  <script src="/js/components/fileDialog.js"></script>
  <script src="/js/components/validation.js"></script>
  <script src="/js/components/dataTable.js"></script>
  <script src="/js/components/widgets-basic.js"></script>
  <script src="/js/components/widgets-complex.js"></script>
  <script src="/js/components/pagination.js"></script>
  <script src="/js/components/modals.js"></script>
  <script src="/js/components/tabs.js"></script>
  <script src="/js/components/columns.js"></script>
  <script src="/js/components/chat.js"></script>
  <script src="/js/app.js"></script>
</body>
</html>
